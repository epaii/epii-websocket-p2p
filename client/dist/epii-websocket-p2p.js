!function(e,s){"object"==typeof exports&&"object"==typeof module?module.exports=s(require("ws")):"function"==typeof define&&define.amd?define(["ws"],s):"object"==typeof exports?exports.WebSocketP2P=s(require("ws")):e.WebSocketP2P=s(e.ws)}(this,(e=>{return s={629:(e,s,t)=>{function i(e){let s=e;if(e)return[s,null];{let e=null;return s=function(s){e&&e(s)},[s,new Promise(((s,t)=>{e=s}))]}}e.exports=class{constructor(e,s,t={}){this.ready_callbacks=[],this.url=e,this.epii_id=s,this.epii_info=t,this.epii_servers={},this.cbs=[],this.__on_error=null,this._start(),this._close_by_self=!1,this.onUserAvailable_cbs={},this.heart_rate_runing=!1,t.heart_rate?this.heart_rate=t.heart_rate:this.heart_rate=3e4}_pushcb(e){if(!e)return-1;let s=this.cbs.length;return this.cbs.push(e),s}_heart_rate(){this.heart_rate_runing||(this.heart_rate_runing=!0,setInterval((()=>{this.is_ready&&this.ws.send(JSON.stringify({hr:1}))}),this.heart_rate))}_start(){this.is_ready=!1,this._close_by_self=!1,"undefined"!=typeof uni?this.ws={}:"object"==typeof window&&window.WebSocket?this.ws=new WebSocket(this.url):"undefined"==typeof WebSocket&&(this.ws=new(t(836))(this.url)),this.ws.onclose=e=>{this._close_by_self||this._start()},this.ws.onopen=()=>{let e=()=>{this.send({do:"login",id:this.epii_id,unique:this.epii_info.unique?1:0,info:this.epii_info,cb:this._pushcb((e=>{e.code-1==0?(this.is_ready=!0,this.ready_callbacks.forEach((e=>e())),this._heart_rate()):this.__on_error&&this.__on_error({msg:"it is has exist username "+this.epii_id+" "})}))},!0)};this.epii_info.hasOwnProperty("__unique__")&&1===this.epii_info.__unique__?this.ping(this.epii_id,(s=>{s.code-1==0?this.__on_error&&this.__on_error({msg:"exist id "+this.epii_id}):e()})):e()},this.ws.onmessage=e=>{try{let s=JSON.parse(e.data);s.hasOwnProperty("do")&&this[s.do]&&this[s.do](s)}catch(e){console.log(e)}},this.ws.onerror=e=>{this._close_by_self||setTimeout((()=>{this._start()}),2e3),this.__on_error&&this.__on_error(e)},"undefined"!=typeof uni&&(uni.onSocketOpen(this.ws.onopen),uni.onSocketError(this.ws.onerror),uni.onSocketMessage(this.ws.onmessage),uni.onSocketClose(this.ws.onclose),this.ws.send=function(e){uni.sendSocketMessage({data:e})},this.ws.close=function(){uni.closeSocket()},uni.connectSocket({url:this.url}))}onUserAvailable(e,s){this.onUserAvailable_cbs[e]||(this.onUserAvailable_cbs[e]=[]),this.onUserAvailable_cbs[e].push(s),this.send({do:"onUserAvailable",toid:e,id:this.epii_id})}regServer(e,s){this.epii_servers[e]=s,this.send({do:"regServer",name:e})}callServer(e,s,t,r=null){const[n,o]=i(r);if(this.send({do:"callServer",id:e,name:s,data:t,cb:this._pushcb(n)}),o)return o}async waitForServer(e,s,t=null){let r=function(e){return new Promise((s=>setTimeout(s,e)))};for(;;){const[t,n]=i(null);if(this.send({do:"checkServer",id:e,name:s,data:{},cb:this._pushcb(t)}),(await n).code-1==0)break;await r(1e3)}t&&t()}sendTo(e,s,t,r=null){const[n,o]=i(r);if(this.send({do:"callServer",id:e,name:s,more:1,data:t,cb:this._pushcb(n)}),o)return o}ping(e,s=null){const[t,r]=i(s);if(this.callServer(e,"__ping",{__ping:1},t),r)return r}exit(){this._close_by_self=!0,this.ws.close()}close(){this.exit()}async __callServer(e){if(this.epii_servers.hasOwnProperty(e.name)){let s=s=>{e.cb-1!=-2&&(s instanceof Error&&(s={$error_code:-200,$error_msg:s.message}),this.send({do:"reponseCall",connect:e.connect,data:s,cb:e.cb}))};const t=this.epii_servers[e.name],i={data:e.data,client:e.client};if(2==function(e){const s=/\(\s*([\s\S]*?)\s*\)/.exec(e)[1];return 0==s.length?0:s.split(/\s*,\s*/).length}(t))try{await t(i,s)}catch(e){s(e)}else try{s(await t(i))}catch(e){s(e)}}}__callback(e){this.cbs.hasOwnProperty(e.cb)&&(e.data&&e.data.$error_code&&e.data.$error_code-0!=0?this.cbs[e.cb](null,e.data):this.cbs[e.cb](e.data,null))}__onUserAvailable(e){this.onUserAvailable_cbs[e.id]&&(delete e.do,this.onUserAvailable_cbs[e.id].forEach((s=>s(e))))}send(e,s){s?this.ws.send(JSON.stringify(e)):this.ready((()=>{this.ws.send(JSON.stringify(e))}))}isReady(){return this.is_ready}ready(e=null){const[s,t]=i(e);if(this.is_ready?s():this.ready_callbacks.push(s),t)return t}onError(e){this.__on_error=e}}},836:s=>{"use strict";s.exports=e}},t={},function e(i){var r=t[i];if(void 0!==r)return r.exports;var n=t[i]={exports:{}};return s[i](n,n.exports,e),n.exports}(629);var s,t}));