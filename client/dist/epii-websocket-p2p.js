!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t(require("ws")):"function"==typeof define&&define.amd?define(["ws"],t):"object"==typeof exports?exports.WebSocketP2P=t(require("ws")):e.WebSocketP2P=t(e.ws)}(this,(e=>{return t={629:(e,t,s)=>{function i(e){let t=e;if(e)return[t,null];{let e=null;return t=function(t){e&&e(t)},[t,new Promise(((t,s)=>{e=t}))]}}e.exports=class{constructor(e,t,s={},i=null){this.ready_callbacks=[],this.url=e,this.epii_id=t,this.epii_info=s,this.epii_servers={},this.cbs=[],this.__on_error=null,this._close_by_self=!1,this.onUserAvailable_cbs={},this.heart_rate_runing=!1,s.heart_rate?this.heart_rate=s.heart_rate:this.heart_rate=3e4,this.heart_rate_thread=null,this.onLogin=i,setTimeout((()=>{this._start()}),100)}onLogin(e){this.onLogin=e}_pushcb(e){if(!e)return-1;let t=this.cbs.length;return this.cbs.push(e),t}_heart_rate(){this.heart_rate_runing||(this.heart_rate_runing=!0,this.heart_rate_thread=setInterval((()=>{this.is_ready&&this.ws.send(JSON.stringify({hr:1}))}),this.heart_rate))}_start(){this.is_ready=!1,this._close_by_self=!1,this.heart_rate_thread&&clearInterval(this.heart_rate_thread),"undefined"!=typeof uni?this.ws={}:"object"==typeof window&&window.WebSocket?this.ws=new WebSocket(this.url):"undefined"==typeof WebSocket&&(this.ws=new(s(836))(this.url)),this.ws.onclose=e=>{this._close_by_self||this._close_by_self||setTimeout((()=>{this._start()}),2e3)},this.ws.onopen=()=>{this.epii_info.unique&&(this.epii_info.__unique__=this.epii_info.unique),(()=>{this.send({do:"login",id:this.epii_id,unique:this.epii_info.__unique__-1==0?1:0,info:this.epii_info,cb:this._pushcb((e=>{e.code-1==0?(this.is_ready=!0,this.onLogin&&this.onLogin(),this.ready_callbacks.forEach((e=>e())),this._heart_rate()):this.__on_error&&this.__on_error({msg:"it is has exist username "+this.epii_id+" "})}))},!0)})()},this.ws.onmessage=e=>{try{let t=JSON.parse(e.data);t.hasOwnProperty("do")&&this[t.do]&&this[t.do](t)}catch(e){console.log(e)}},this.ws.onerror=e=>{this.__on_error&&this.__on_error(e)},"undefined"!=typeof uni&&(uni.onSocketOpen(this.ws.onopen),uni.onSocketError(this.ws.onerror),uni.onSocketMessage(this.ws.onmessage),uni.onSocketClose(this.ws.onclose),this.ws.send=function(e){uni.sendSocketMessage({data:e})},this.ws.close=function(){uni.closeSocket()},uni.connectSocket({url:this.url}))}onUserAvailable(e,t){this.onUserAvailable_cbs[e]||(this.onUserAvailable_cbs[e]=[]),this.onUserAvailable_cbs[e].push(t),this.send({do:"onUserAvailable",toid:e,id:this.epii_id})}regServer(e,t){this.epii_servers[e]=t,this.send({do:"regServer",name:e})}callServer(e,t,s,r=null){const[n,o]=i(r);if(this.send({do:"callServer",id:e,name:t,data:s,cb:this._pushcb(n)}),o)return o}async waitForServer(e,t,s=null){let r=function(e){return new Promise((t=>setTimeout(t,e)))};for(;;){const[s,n]=i(null);if(this.send({do:"checkServer",id:e,name:t,data:{},cb:this._pushcb(s)}),(await n).code-1==0)break;await r(1e3)}s&&s()}async checkServer(e,t){const[s,r]=i(null);return this.send({do:"checkServer",id:e,name:t,data:{},cb:this._pushcb(s)}),(await r).code-1==0}sendTo(e,t,s,r=null){const[n,o]=i(r);if(this.send({do:"callServer",id:e,name:t,more:1,data:s,cb:this._pushcb(n)}),o)return o}ping(e,t=null){const[s,r]=i(t);if(this.callServer(e,"__ping",{__ping:1},s),r)return r}exit(){this._close_by_self=!0,this.ws.close()}close(){this.exit()}async __callServer(e){if(this.epii_servers.hasOwnProperty(e.name)){let t=t=>{e.cb-1!=-2&&(t instanceof Error&&(t={$error_code:-200,$error_msg:t.message}),this.send({do:"reponseCall",connect:e.connect,data:t,cb:e.cb}))};const s=this.epii_servers[e.name],i={data:e.data,client:e.client};if(2==function(e){const t=/\(\s*([\s\S]*?)\s*\)/.exec(e)[1];return 0==t.length?0:t.split(/\s*,\s*/).length}(s))try{await s(i,t)}catch(e){t(e)}else try{t(await s(i))}catch(e){t(e)}}}__callback(e){this.cbs.hasOwnProperty(e.cb)&&(e.data&&e.data.$error_code&&e.data.$error_code-0!=0?this.cbs[e.cb](null,e.data):this.cbs[e.cb](e.data,null))}__onUserAvailable(e){this.onUserAvailable_cbs[e.id]&&(delete e.do,this.onUserAvailable_cbs[e.id].forEach((t=>t(e))))}send(e,t){t?this.ws.send(JSON.stringify(e)):this.ready((()=>{this.ws.send(JSON.stringify(e))}))}isReady(){return this.is_ready}ready(e=null){const[t,s]=i(e);if(this.is_ready?t():this.ready_callbacks.push(t),s)return s}onError(e){this.__on_error=e}}},836:t=>{"use strict";t.exports=e}},s={},function e(i){var r=s[i];if(void 0!==r)return r.exports;var n=s[i]={exports:{}};return t[i](n,n.exports,e),n.exports}(629);var t,s}));